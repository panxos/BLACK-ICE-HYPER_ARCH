#!/bin/bash
# wallpaper_switcher: Selector interactivo optimizado para BLACK-ICE 
# Detect dynamic XDG Pictures dir
if command -v xdg-user-dir &>/dev/null; then
    PICTURES_DIR=$(xdg-user-dir PICTURES)
    [ -z "$PICTURES_DIR" ] && PICTURES_DIR="$HOME/Pictures"
else
    PICTURES_DIR="$HOME/Pictures"
fi

WALL_DIR="$PICTURES_DIR/wallpapers"
STATE_FILE="$HOME/.config/hypr/.current_wallpaper"

# Ensure swww-daemon is running
if ! pgrep -x "swww-daemon" > /dev/null; then
    swww-daemon &
    sleep 1
fi

# Recoger todos los wallpapers PNG, JPG y MP4
shopt -s nullglob
wallpapers=("$WALL_DIR"/*.{png,jpg,jpeg,mp4})
num_walls=${#wallpapers[@]}

if [ $num_walls -eq 0 ]; then
    notify-send "Wallpaper System" "Error: No se encontraron archivos de imagen o video en $WALL_DIR"
    exit 1
fi

# Calcular siguiente índice
current_idx=$(cat "$STATE_FILE" 2>/dev/null || echo "0")
next_idx=$(( (current_idx + 1) % num_walls ))
echo "$next_idx" > "$STATE_FILE"

new_wall="${wallpapers[$next_idx]}"

# Aplicar según tipo de archivo
if [[ "$new_wall" == *.mp4 ]]; then
    pkill swww-daemon 2>/dev/null
    pkill mpvpaper 2>/dev/null
    sleep 0.5
    mpvpaper -o "no-audio --loop" "*" "$new_wall" &>/dev/null &
else
    pkill mpvpaper 2>/dev/null
    if ! pgrep -x "swww-daemon" > /dev/null; then
        swww-daemon &
        sleep 0.5
    fi
    swww img "$new_wall" --transition-type wipe --transition-duration 2
fi

notify-send "BLACK-ICE" "Applied: $(basename "$new_wall")"
